#!/bin/sh
set -eu

# Guard / Passthrough - exit early if not in shim context
if [ "${TERM_PROGRAM:-}" != "WezTerm" ] || [ -z "${WEZTERM_SHIM_LIB:-}" ]; then
    real_tmux="${REAL_TMUX:-$(command -v tmux 2>/dev/null || true)}"
    if [ -n "$real_tmux" ]; then
        exec "$real_tmux" "$@"
    fi
    echo "tmux: command not found" >&2
    exit 127
fi

# Source the pane-map library
. "$WEZTERM_SHIM_LIB"

# Handler: version
handle_version() {
    echo "tmux 3.4"
}

# Handler: display-message
handle_display_message() {
    target=""
    format=""
    while [ $# -gt 0 ]; do
        case "$1" in
            -t) target="$2"; shift 2 ;;
            -p) format="$2"; shift 2 ;;
            *)  shift ;;
        esac
    done
    case "$format" in
        *'#{pane_id}'*)
            if [ -n "$target" ]; then
                echo "$target"
            else
                echo "${TMUX_PANE:-}"
            fi
            return 0
            ;;
        *'#{session_name}:#{window_index}'*)
            _tab_id="${WEZTERM_SHIM_TAB:-0}"
            if [ -n "$target" ]; then
                _tab_id=$(tab_for_pane "$target")
            fi
            echo "wezterm:${_tab_id}"
            return 0
            ;;
    esac
    echo "$format"
}

# Handler: split-window
handle_split_window() {
    target="${TMUX_PANE:-}"
    direction="--bottom"
    size=""
    print_flag=false
    format="#{pane_id}"
    while [ $# -gt 0 ]; do
        case "$1" in
            -t) target="$2"; shift 2 ;;
            -h) direction="--right"; shift ;;
            -v) direction="--bottom"; shift ;;
            -l) size="$2"; shift 2 ;;
            -P) print_flag=true; shift ;;
            -F) format="$2"; shift 2 ;;
            *)  shift ;;
        esac
    done
    wez_pane=$(wez_from_tmux "$target")
    split_args="$direction --pane-id $wez_pane"
    if [ -n "$size" ]; then
        percent="${size%%%}"
        split_args="$split_args --percent $percent"
    fi
    new_wez_pane=$(wezterm cli split-pane $split_args)
    _tab_id=$(tab_for_pane "$target")
    new_tmux_id=$(alloc_pane_id "$new_wez_pane" "$_tab_id")
    if [ "$print_flag" = true ]; then
        echo "$new_tmux_id"
    fi
}

# Handler: send-keys
handle_send_keys() {
    target="${TMUX_PANE:-}"
    cmd=""
    has_enter=false
    while [ $# -gt 0 ]; do
        case "$1" in
            -t) target="$2"; shift 2 ;;
            Enter|C-m)
                has_enter=true
                shift
                ;;
            *)
                if [ -n "$cmd" ]; then
                    cmd="$cmd $1"
                else
                    cmd="$1"
                fi
                shift
                ;;
        esac
    done
    wez_pane=$(wez_from_tmux "$target")
    if [ "$has_enter" = true ]; then
        printf '%s\n' "$cmd" | wezterm cli send-text --no-paste --pane-id "$wez_pane"
    else
        printf '%s' "$cmd" | wezterm cli send-text --no-paste --pane-id "$wez_pane"
    fi
}

# Handler: list-panes
handle_list_panes() {
    target="${WEZTERM_SHIM_TAB:-0}"
    format="#{pane_id}"
    while [ $# -gt 0 ]; do
        case "$1" in
            -t) target="$2"; shift 2 ;;
            -F) format="$2"; shift 2 ;;
            *)  shift ;;
        esac
    done
    case "$target" in
        %*)  _tab_id=$(tab_for_pane "$target") ;;
        wezterm:*) _tab_id="${target#wezterm:}" ;;
        *)   _tab_id="$target" ;;
    esac
    panes=$(panes_in_tab "$_tab_id")
    if [ -n "$panes" ]; then
        echo "$panes"
    fi
}

# Handler: select-pane
handle_select_pane() {
    target="${TMUX_PANE:-}"
    has_style=false
    while [ $# -gt 0 ]; do
        case "$1" in
            -t) target="$2"; shift 2 ;;
            -P|-T) has_style=true; shift 2 ;;
            *)  shift ;;
        esac
    done
    if [ "$has_style" = true ]; then
        exit 0
    fi
    wez_pane=$(wez_from_tmux "$target")
    wezterm cli activate-pane --pane-id "$wez_pane" >/dev/null 2>&1
}

# Handler: kill-pane
handle_kill_pane() {
    target="${TMUX_PANE:-}"
    while [ $# -gt 0 ]; do
        case "$1" in
            -t) target="$2"; shift 2 ;;
            *)  shift ;;
        esac
    done
    wez_pane=$(wez_from_tmux "$target")
    wezterm cli kill-pane --pane-id "$wez_pane" >/dev/null 2>&1
    remove_pane "$target"
}

# Dispatch
cmd="${1:-}"
shift || true

case "$cmd" in
    -V)
        handle_version
        ;;
    display-message)
        handle_display_message "$@"
        ;;
    split-window)
        handle_split_window "$@"
        ;;
    send-keys)
        handle_send_keys "$@"
        ;;
    list-panes)
        handle_list_panes "$@"
        ;;
    select-pane)
        handle_select_pane "$@"
        ;;
    kill-pane)
        handle_kill_pane "$@"
        ;;
    select-layout|resize-pane|set-option|set-window-option|\
    has-session|new-session|new-window|list-sessions|list-windows|\
    break-pane|join-pane|move-window|swap-pane)
        exit 0
        ;;
    *)
        if [ -n "${REAL_TMUX:-}" ]; then
            exec "$REAL_TMUX" "$cmd" "$@"
        fi
        echo "wezcld: unhandled command: $cmd" >&2
        exit 1
        ;;
esac
