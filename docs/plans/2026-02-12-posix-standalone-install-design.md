# Design: POSIX Compatibility & Standalone Install

## Summary

Make wezcld scripts POSIX sh compatible (bash + zsh) and create a self-extracting installer with zero repo dependency.

## Decisions

- **Shell compat:** All scripts use `#!/bin/sh`, no bash-isms
- **Install dir:** `~/.local/share/wezcld/` (XDG-compliant)
- **Bin wrappers:** Thin exec scripts in `~/.local/bin/`, not symlinks
- **Install method:** `curl -fsSL <url> | sh` â€” self-extracting, embedded heredocs
- **PATH setup:** Auto-append to `.bashrc`/`.zshrc` with `# wezcld` marker
- **jq:** Kept as documented dependency
- **Generated installer:** Committed at repo root `install.sh`
- **Uninstall:** `install.sh --uninstall` removes everything

## POSIX-ification

| Bash feature | POSIX replacement |
|---|---|
| `[[ ... ]]` | `[ ... ]` with quoting |
| Arrays | Positional params or delimited strings |
| Process substitution `< <()` | Pipe or temp file |
| `type -a` | PATH scanning loop |
| `[[ "$x" == *pat* ]]` | `case "$x" in *pat*) ... esac` |
| `readlink` (GNU) | POSIX readlink loop |

## Install Layout

```
~/.local/share/wezcld/
  bin/wezcld        # Full launcher (copied)
  bin/tmux          # Full shim (copied)
  lib/pane-map.sh   # Mapping lib (copied)

~/.local/bin/
  wezcld            # exec ~/.local/share/wezcld/bin/wezcld "$@"
  tmux              # exec ~/.local/share/wezcld/bin/tmux "$@"

~/.local/state/wezcld/
  pane-map          # Runtime state
  counter           # Pane ID counter
  real-tmux-path    # Saved real tmux location
```

## Self-Extracting Installer

`install.sh` at repo root (generated by `scripts/build-installer.sh`):

1. Check deps (jq, wezterm)
2. Find real tmux in PATH (skip `~/.local/bin`)
3. Create dirs
4. Extract heredoc-embedded files into `~/.local/share/wezcld/`
5. Create thin wrappers in `~/.local/bin/`
6. Save real tmux path
7. Detect shell, add PATH to rc file if needed
8. Print success

Supports `--uninstall` to reverse all steps.

## Build Script

`scripts/build-installer.sh` reads source files, generates `install.sh` with embedded heredocs. Must re-run when scripts change.

## Repo Structure After

```
wezterm-tmux-shim/
  bin/wezcld              # Source
  bin/tmux                # Source
  lib/pane-map.sh         # Source
  scripts/build-installer.sh
  install.sh              # Generated (committed)
  tests/integration-test.sh
  docs/plans/
```
